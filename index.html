<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSW News Portal - Suansri Wittaya School (Forum Style)</title>
    <style>
        /* --- CSS STYLING: Global Variables & Base Styles --- */
        :root {
            --ssw-green: #004d40; 
            --ssw-yellow: #ffc107; 
            --light-bg: #f4f4f4;
            --text-dark: #333;
            --text-light: #fff;
            --border-color: #ccc;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545; 
            --info-color: #007bff;
            --comment-bg: #f8f8f8; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Comment */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- LOGIN & HEADER STYLES (Keep the same) --- */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f0f0f0; 
        }

        .login-container {
            background-color: var(--text-light);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .header { margin-bottom: 30px; }
        .logo { width: 80px; height: 80px; margin-bottom: 10px; border-radius: 50%; }
        .header h1 { color: var(--ssw-green); margin-top: 0; margin-bottom: 5px; font-size: 2em; }
        .header p { color: var(--text-dark); font-size: 0.9em; font-weight: 300; }

        .login-type-selection { display: flex; gap: 15px; margin-bottom: 25px; }
        .login-type-selection button { flex: 1; padding: 10px; border: 2px solid var(--ssw-green); background-color: var(--ssw-green); color: var(--ssw-yellow); border-radius: 6px; cursor: pointer; font-weight: bold; transition: background-color 0.3s, opacity 0.3s; }
        .login-type-selection button.inactive { background-color: transparent; color: var(--ssw-green); border-color: #e0e0e0; }
        
        .login-form-content { border-top: 1px solid #eee; padding-top: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-dark); font-size: 0.95em; }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box; 
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .action-button {
            width: 100%;
            padding: 12px;
            background-color: var(--ssw-green); 
            color: var(--ssw-yellow); 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .post-button { background-color: var(--info-color); color: white; margin-top: 0; }
        .post-button:hover { background-color: #0056b3; }

        /* --- NEWS CONTENT STYLES --- */
        #news-content { display: none; }
        header { background-color: var(--ssw-green); color: white; padding: 20px 0; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .container { width: 90%; max-width: 1200px; margin: 20px auto; padding: 0 10px; }
        
        #post-creation-form {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .news-article {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            position: relative;
        }

        .news-article h2 { color: var(--ssw-green); font-size: 1.5em; margin-top: 0; }
        .news-article .author { font-size: 0.8em; color: var(--info-color); margin-bottom: 10px; display: block; font-style: italic; }
        .delete-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            float: right; 
            font-size: 0.9em;
            margin-left: 10px;
        }
        .read-more-btn { display: none; } 

        /* --- COMMENT SECTION STYLES (NEW) --- */
        .comment-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .comment-container {
            border-left: 3px solid var(--ssw-yellow);
            padding-left: 10px;
            margin-top: 10px;
            max-height: 0; /* ‡∏ã‡πà‡∏≠‡∏ô Comment ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .comment-container.open {
            max-height: 5000px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î */
            transition: max-height 1s ease-in;
        }

        .single-comment {
            background-color: var(--comment-bg);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .comment-meta {
            font-weight: bold;
            color: var(--ssw-green);
            margin-right: 10px;
        }
        .comment-date {
            font-size: 0.8em;
            color: #999;
            font-weight: normal;
        }
        .comment-content {
            margin-top: 4px;
        }

        /* Comment Form */
        .comment-form textarea {
            resize: none;
            padding: 8px;
            margin-top: 5px;
        }
        .comment-form button {
            width: auto;
            padding: 6px 12px;
            font-size: 0.9em;
            background-color: var(--info-color);
            color: white;
            margin-top: 5px;
        }

        /* Toggle Button */
        .comment-toggle-btn {
            background-color: transparent;
            border: 1px solid var(--info-color);
            color: var(--info-color);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .comment-toggle-btn:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
    </style>
</head>
<body>

    <div id="login-page" class="login-page">
        <div class="login-container">
            <div class="header">
                <img src="https://via.placeholder.com/80/004d40/ffc107?text=SSW" alt="Suansri Wittaya School Logo" class="logo">
                <h1>SSW News Portal</h1>
                <p id="login-status-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>

            <div class="login-type-selection">
                <button id="user-btn" onclick="setLoginMode('user')">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                <button id="admin-btn" onclick="setLoginMode('admin')" class="inactive">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•/‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß</button>
            </div>

            <div class="login-form-content">
                <div id="instant-login-message">
                    <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥ IP ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏î‡πâ <span id="ip-display"></span></p>
                    <button class="action-button" style="width: auto; padding: 8px 15px;" onclick="instantLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                    <button style="border: none; background: none; color: #555; text-decoration: underline; margin-left: 10px;" onclick="showAdminForm()">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏â‡∏±‡∏ô</button>
                </div>
                
                <form id="user-login-form">
                    <p style="font-size: 1.1em; font-weight: bold; color: var(--ssw-green);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡πà‡∏≤‡∏ß</p>
                    <div class="input-group">
                        <label for="visitor-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå)</label>
                        <input type="text" id="visitor-username" name="visitor-username" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                    </div>
                    <button type="submit" class="action-button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (User Access)</button>
                </form>

                <form id="admin-login-form" style="display: none;">
                    <div class="input-group">
                        <label for="admin-username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Admin/Reporter)</label>
                        <input type="text" id="admin-username" name="admin-username" placeholder="Jocey778 ‡∏´‡∏£‡∏∑‡∏≠ sswadmin" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="admin-password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                        <input type="password" id="admin-password" name="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    
                    <button type="submit" class="action-button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
                </form>
            </div>
        </div>
    </div>

    <div id="news-content">
        <header>
            <h1>SSW News üì¢</h1>
            <p>Suansri Wittaya School Official News & Announcements (Forum Style)</p>
        </header>

        <div class="container">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <p style="margin: 0;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞: <strong id="logged-in-user-display"></strong></p>
                <button class="read-more-btn" onclick="logout()" style="float: right;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
             </div>
            
            <div id="post-creation-form">
                <h2>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="new-post-form">
                    <div class="input-group">
                        <label for="post-title">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</label>
                        <input type="text" id="post-title" required>
                    </div>
                    <div class="input-group">
                        <label for="post-content">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <textarea id="post-content" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="action-button post-button">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ</button>
                </form>
            </div>

            <div class="news-grid" id="news-grid">
                </div>
        </div>

        <footer>
            <p>&copy; 2025 Suansri Wittaya School. All Rights Reserved.</p>
        </footer>
    </div>


    <script>
        // ***************************************************************
        //  ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ API BASE URL ‡πÅ‡∏•‡πâ‡∏ß: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Cloud Run Endpoint ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        // ***************************************************************
        const API_BASE_URL = 'https://ssw-news-api-170685138785.europe-west1.run.app/api'; 
        // ***************************************************************

        // --- CONSTANTS AND ELEMENTS ---
        const ADMIN_IP_KEY = 'ssw_admin_ip';
        const POSTS_CONTAINER = document.getElementById('news-grid');
        const NEW_POST_FORM = document.getElementById('new-post-form');
        const LOGIN_PAGE = document.getElementById('login-page');
        const NEWS_CONTENT = document.getElementById('news-content');
        const USER_FORM = document.getElementById('user-login-form');
        const ADMIN_FORM = document.getElementById('admin-login-form');
        const INSTANT_MESSAGE = document.getElementById('instant-login-message');
        const IP_DISPLAY = document.getElementById('ip-display');
        const STATUS_MESSAGE = document.getElementById('login-status-message');
        const USER_BTN = document.getElementById('user-btn');
        const ADMIN_BTN = document.getElementById('admin-btn');
        const LOGGED_IN_USER_DISPLAY = document.getElementById('logged-in-user-display');
        const POST_CREATION_FORM = document.getElementById('post-creation-form');

        // Admin Accounts
        const VALID_CREDENTIALS = {
            'sswadmin': '1234',
            'Jocey778': 'password'
        };

        // Current User State
        let currentUser = { id: null, username: null, role: null };
        let lastKnownPosts = '';
        let refreshInterval;

        // --- CORE DATA FUNCTIONS (API Version) ---

        async function getPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/posts`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data; 
            } catch (e) {
                console.error("Error fetching posts from API:", e);
                // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Alert ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å CORS ‡∏´‡∏£‡∏∑‡∏≠ SQL
                // alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Cloud Run Service ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà");
                return [];
            }
        }
        
        // --- REAL-TIME SIMULATION ---
        
        function startRealTimeCheck() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(renderPosts, 1000); // Check every 1 second
            console.log("Real-time check started.");
        }

        function stopRealTimeCheck() {
            if (refreshInterval) clearInterval(refreshInterval);
            console.log("Real-time check stopped.");
        }

        // --- RENDERING FUNCTIONS ---
        
        function renderComments(postId, comments) {
            let commentHtml = (comments || []).map(comment => `
                <div class="single-comment">
                    <span class="comment-meta">${comment.author_name || comment.authorName}</span>
                    <span class="comment-date">@ ${comment.created_at || comment.date}</span>
                    <div class="comment-content">${comment.content}</div>
                </div>
            `).join('');

            return `
                <div class="comment-section">
                    <button class="comment-toggle-btn" onclick="toggleComments(${postId})">
                        ${(comments || []).length} ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ ${comments && comments.length > 0 ? '‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á' : '‡πÅ‡∏™‡∏î‡∏á'})
                    </button>
                    <div id="comments-${postId}" class="comment-container">
                        ${commentHtml}
                        <form class="comment-form" onsubmit="handleCommentSubmit(event, ${postId})">
                            <textarea placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." required></textarea>
                            <button type="submit">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function renderPosts() {
            const posts = await getPosts(); 
            
            const postsString = JSON.stringify(posts);

            if (postsString === lastKnownPosts) return; 
            lastKnownPosts = postsString;

            let html = '';
            
            posts.forEach(post => {
                let showDeleteButton = false;
                const postAuthorId = post.author_id; 
                
                if (currentUser.role === 'admin') {
                    showDeleteButton = true;
                } else if (currentUser.role === 'user' && currentUser.id === postAuthorId) {
                    showDeleteButton = true;
                }
                
                const deleteButtonHtml = showDeleteButton 
                    ? `<button class="delete-btn" onclick="deleteArticle(${post.id})">‡∏•‡∏ö X</button>`
                    : '';
                
                const commentsHtml = renderComments(post.id, post.comments || []);
                
                const articleHtml = `
                    <div class="news-article" id="article-${post.id}">
                        ${deleteButtonHtml}
                        <span class="date">${post.created_at}</span>
                        <span class="author">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÇ‡∏î‡∏¢: ${post.author_name}</span>
                        <h2>${post.title}</h2>
                        <p>${post.content}</p>
                        ${commentsHtml}
                    </div>
                `;
                html += articleHtml;
            });

            POSTS_CONTAINER.innerHTML = html;
        }


        // --- ACTION HANDLERS: POSTS (API Version) ---
        
        NEW_POST_FORM.addEventListener('submit', async function(e) { 
            e.preventDefault();
            
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;
            
            if (!currentUser.id) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
                return;
            }

            const postData = {
                title: title,
                content: content,
                authorName: currentUser.username,
                role: currentUser.role
            };

            try {
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });

                if (response.ok) {
                    NEW_POST_FORM.reset();
                    alert(`‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà "${title}" ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß! (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô SQL)`);
                    renderPosts(); 
                } else {
                    const error = await response.json();
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ: ${error.message}`);
                }
            } catch (error) {
                console.error('API Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server (POST)');
            }
        });
        
        window.deleteArticle = async function(postId) { 
            const posts = await getPosts();
            const post = posts.find(p => p.id === postId); // ‡πÉ‡∏ä‡πâ p.id ‡∏à‡∏≤‡∏Å API response
            
            if (!post) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ");

            const postAuthorId = post.author_id;
            let authorized = (currentUser.role === 'admin' || (currentUser.role === 'user' && currentUser.id === postAuthorId));

            if (!authorized) {
                alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ");
                return;
            }

            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ: "${post.title}" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                        method: 'DELETE',
                    });
                    
                    if (response.ok) {
                        alert(`‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ "${post.title}" ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
                        renderPosts();
                    } else {
                        const error = await response.json();
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`);
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ (DELETE)');
                }
            }
        }
        
        // --- ACTION HANDLERS: COMMENTS (API Version) ---
        
        window.toggleComments = function(postId) {
            const commentContainer = document.getElementById(`comments-${postId}`);
            if (commentContainer) {
                commentContainer.classList.toggle('open');
            }
        }
        
        window.handleCommentSubmit = async function(e, postId) { 
            e.preventDefault();
            
            const form = e.target;
            const textarea = form.querySelector('textarea');
            const commentContent = textarea.value.trim();

            if (!commentContent || !currentUser.id) return;

            const commentData = {
                authorName: currentUser.username,
                content: commentContent,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(commentData)
                });

                if (response.ok) {
                    textarea.value = ''; 
                    renderPosts(); 
                    
                    setTimeout(() => {
                        const commentContainer = document.getElementById(`comments-${postId}`);
                        if (commentContainer && !commentContainer.classList.contains('open')) {
                            commentContainer.classList.add('open');
                        }
                    }, 100);

                } else {
                    const error = await response.json();
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`);
                }
            } catch (error) {
                console.error('API Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server (POST Comment)');
            }
        }
        
        // --- LOGIN/FLOW FUNCTIONS ---

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return null;
            }
        }

        function showNewsContent(user) {
            currentUser = user; 
            LOGIN_PAGE.style.display = 'none';
            NEWS_CONTENT.style.display = 'block';
            document.body.style.backgroundColor = 'var(--light-bg)';
            LOGGED_IN_USER_DISPLAY.textContent = `${user.username} (${user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' : '‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'})`;
            POST_CREATION_FORM.style.display = 'block'; 
            
            renderPosts(); 
            startRealTimeCheck(); 
        }

        function logout() {
            stopRealTimeCheck();
            alert('‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            currentUser = { id: null, username: null, role: null };
            NEWS_CONTENT.style.display = 'none';
            LOGIN_PAGE.style.display = 'flex';
            setLoginMode('user');
        }

        function setLoginMode(mode) {
            stopRealTimeCheck();
            USER_BTN.classList.remove('inactive');
            ADMIN_BTN.classList.remove('inactive');
            
            USER_FORM.style.display = 'none';
            ADMIN_FORM.style.display = 'none';
            INSTANT_MESSAGE.style.display = 'none';

            if (mode === 'user') {
                ADMIN_BTN.classList.add('inactive');
                STATUS_MESSAGE.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                USER_FORM.style.display = 'block';
            } else if (mode === 'admin') {
                USER_BTN.classList.add('inactive');
                STATUS_MESSAGE.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•/‡∏ô‡∏±‡∏Å‡∏Ç‡πà‡∏≤‡∏ß';
                checkInstantLogin(); 
            }
        }

        function showAdminForm() {
            INSTANT_MESSAGE.style.display = 'none';
            ADMIN_FORM.style.display = 'block';
        }

        async function checkInstantLogin() {
            const storedIP = localStorage.getItem(ADMIN_IP_KEY);
            const currentIP = await getClientIP();
            
            if (storedIP && currentIP && storedIP === currentIP) {
                ADMIN_FORM.style.display = 'none';
                IP_DISPLAY.textContent = `(${currentIP})`;
                INSTANT_MESSAGE.style.display = 'block';
            } else {
                showAdminForm();
            }
        }

        function instantLogin() {
            const defaultAdminUsername = Object.keys(VALID_CREDENTIALS)[0]; 
            showNewsContent({ 
                id: `admin_${defaultAdminUsername}`, 
                username: defaultAdminUsername, 
                role: 'admin' 
            });
        }

        // --- EVENT LISTENERS ---

        USER_FORM.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('visitor-username').value;
            // ID ‡πÉ‡∏ô Frontend ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏ö (authorId ‡πÉ‡∏ô SQL)
            showNewsContent({ id: `user_${username}`, username: username, role: 'user' }); 
        });

        ADMIN_FORM.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (VALID_CREDENTIALS[username] === password) { 
                const currentIP = await getClientIP();
                if (currentIP) {
                    localStorage.setItem(ADMIN_IP_KEY, currentIP);
                } 
                showNewsContent({ id: `admin_${username}`, username: username, role: 'admin' });
            } else {
                 alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: sswadmin/1234 ‡∏´‡∏£‡∏∑‡∏≠ Jocey778/password)');
            }
        });

        // Run default mode check when the page loads
        setLoginMode('user'); 
    </script>
</body>
</html>
